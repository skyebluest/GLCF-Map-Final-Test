<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width" />
  <title>GLCF Map with Polygon Labels</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <!-- Open Sans font -->
  <link
    href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@700&display=swap"
    rel="stylesheet"
  />
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Open Sans', sans-serif;
    }
    .town-label {
      background: none !important;
      box-shadow: none !important;
      border: none !important;
      pointer-events: none;
    }
    .town-label div {
      background: none !important;
      padding: 2px 6px;
      border-radius: 0;
      text-align: center;
      font-weight: 700;
      font-size: 12px;
      color: #e7e2d3;
      white-space: nowrap;
      user-select: none;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>
  <!-- Turf.js -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <!-- Your GeoJSON data file -->
  <script src="data/48_1.js"></script>

  <script>
    window.onload = function () {
      if (!window.json_48_1) {
        console.error("GeoJSON data 'json_48_1' not found! Make sure 'data/48_1.js' is loaded.");
        return;
      }

      // Initialize map
      var map = L.map("map", {
        center: [42.5748, -71.5146],
        zoom: 11,
        zoomControl: true,
        scrollWheelZoom: false,
      });

      // Add OpenStreetMap tile layer
      L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      }).addTo(map);

      // Style for polygons
      function style(feature) {
        return {
          color: "rgba(35,35,35,1.0)",
          weight: 1,
          fillColor: "rgba(40,86,156,1.0)",
          fillOpacity: 1,
        };
      }

      // Popup content
      function onEachFeature(feature, layer) {
        let props = feature.properties;
        let content = `<table>
          <tr><th>TOWN</th><td>${props.TOWN || ""}</td></tr>
          <tr><th>2022 Total</th><td>${props["2022 Total"] || ""}</td></tr>
        </table>`;
        layer.bindPopup(content);
      }

      // Add GeoJSON layer
      var layer_48_1 = L.geoJSON(window.json_48_1, {
        style: style,
        onEachFeature: onEachFeature,
      }).addTo(map);

      // Label layer group
      var townLabels = L.layerGroup().addTo(map);

      function measureLabelSize(text) {
        const tempDiv = document.createElement("div");
        tempDiv.style.position = "absolute";
        tempDiv.style.visibility = "hidden";
        tempDiv.style.fontFamily = "'Open Sans', sans-serif";
        tempDiv.style.fontWeight = "700";
        tempDiv.style.fontSize = "12px";
        tempDiv.style.whiteSpace = "nowrap";
        tempDiv.style.padding = "2px 6px";
        tempDiv.innerText = text;
        document.body.appendChild(tempDiv);
        const width = tempDiv.offsetWidth;
        const height = tempDiv.offsetHeight;
        document.body.removeChild(tempDiv);
        return { width, height };
      }

      function getOffsetLatLng(baseLatLng, dxPixels, dyPixels) {
        const point = map.latLngToContainerPoint(baseLatLng);
        const offsetPoint = L.point(point.x + dxPixels, point.y + dyPixels);
        return map.containerPointToLatLng(offsetPoint);
      }

      function labelFitsInsidePolygon(feature, labelLatLng, labelWidth, labelHeight) {
        const topLeft = getOffsetLatLng(labelLatLng, -labelWidth / 2, -labelHeight);
        const topRight = getOffsetLatLng(labelLatLng, labelWidth / 2, -labelHeight);
        const bottomRight = getOffsetLatLng(labelLatLng, labelWidth / 2, 0);
        const bottomLeft = getOffsetLatLng(labelLatLng, -labelWidth / 2, 0);

        const labelPolygon = turf.polygon([
          [
            [topLeft.lng, topLeft.lat],
            [topRight.lng, topRight.lat],
            [bottomRight.lng, bottomRight.lat],
            [bottomLeft.lng, bottomLeft.lat],
            [topLeft.lng, topLeft.lat],
          ],
        ]);

        const flattened = turf.flatten(feature);

        for (const polyFeature of flattened.features) {
          if (turf.booleanContains(polyFeature, labelPolygon)) {
            return true;
          }
        }
        return false;
      }

      townLabels.clearLayers();

      layer_48_1.eachLayer(function (layer) {
        const feature = layer.feature;
        if (!feature || !feature.geometry) return;

        const townName = feature.properties.TOWN || "Unknown";
        const pointOnFeature = turf.pointOnFeature(feature);
        let labelLatLng = L.latLng(
          pointOnFeature.geometry.coordinates[1],
          pointOnFeature.geometry.coordinates[0]
        );

        const { width: labelWidth, height: labelHeight } = measureLabelSize(townName);

        let fits = false;
        const maxShift = 40; // max pixels to shift left
        for (let dx = 0; dx >= -maxShift; dx -= 2) {
          const testLatLng = getOffsetLatLng(labelLatLng, dx, 0);
          if (labelFitsInsidePolygon(feature, testLatLng, labelWidth, labelHeight)) {
            labelLatLng = testLatLng;
            fits = true;
            break;
          }
        }

        if (fits) {
          const labelMarker = L.marker(labelLatLng, {
            icon: L.divIcon({
              className: "town-label",
              html: `<div>${townName}</div>`,
              iconSize: null,
            }),
            interactive: false,
          });
          townLabels.addLayer(labelMarker);
          console.log(`Label added for ${townName}`);
        } else {
          console.warn(`Label for "${townName}" doesn't fit after leftward shift; omitted.`);
        }
      });

      // Fit map to layer bounds with padding
      map.fitBounds(layer_48_1.getBounds().pad(0.1));
    };
  </script>
</body>
</html>
