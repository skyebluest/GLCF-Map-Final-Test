<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width"
    />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <link rel="stylesheet" href="css/leaflet.css" />
    <link rel="stylesheet" href="css/qgis2web.css" />
    <link rel="stylesheet" href="css/fontawesome-all.min.css" />
    <link rel="stylesheet" href="css/leaflet.photon.css" />
    <link rel="stylesheet" href="css/leaflet-measure.css" />
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@700&display=swap"
      rel="stylesheet"
    />
    <style>
      html,
      body,
      #map {
        width: 100%;
        height: 100vh;
        margin: 0;
        padding: 0;
      }
      .town-label {
        background: none !important;
        box-shadow: none !important;
        border: none !important;
      }
      .town-label div {
        background: none !important;
        padding: 2px 6px;
        border-radius: 0;
        text-align: center;
        font-family: 'Open Sans', sans-serif;
        font-weight: 700;
        font-size: 12px;
        color: #e7e2d3;
        white-space: nowrap;
        pointer-events: none;
      }
    </style>
    <title>Map with Labels</title>
  </head>
  <body>
    <div id="map"></div>

    <script src="js/qgis2web_expressions.js"></script>
    <script src="js/leaflet.js"></script>
    <script src="js/L.Control.Layers.Tree.min.js"></script>
    <script src="js/leaflet.rotatedMarker.js"></script>
    <script src="js/leaflet.pattern.js"></script>
    <script src="js/leaflet-hash.js"></script>
    <script src="js/Autolinker.min.js"></script>
    <script src="js/rbush.min.js"></script>
    <script src="js/labelgun.min.js"></script>
    <script src="js/leaflet.photon.js"></script>
    <script src="js/leaflet-measure.js"></script>

    <!-- GeoJSON data -->
    <script src="data/48_1.js"></script>

    <script>
      window.onload = function () {
        if (typeof json_48_1 === 'undefined') {
          console.error('GeoJSON data "json_48_1" not loaded or missing!');
          return;
        }

        const map = L.map('map', {
          zoomControl: false,
          maxZoom: 11,
          minZoom: 11,
        });

        new L.Hash(map);

        map.attributionControl.setPrefix(
          '<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="Leaflet">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>'
        );

        const autolinker = new Autolinker({ truncate: { length: 30, location: 'smart' } });

        // Popup helper functions (same as yours)
        function removeEmptyRowsFromPopupContent(content, feature) {
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = content;
          const rows = tempDiv.querySelectorAll('tr');
          for (let i = 0; i < rows.length; i++) {
            const td = rows[i].querySelector('td.visible-with-data');
            const key = td ? td.id : '';
            if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
              rows[i].parentNode.removeChild(rows[i]);
            }
          }
          return tempDiv.innerHTML;
        }
        function addClassToPopupIfMedia(content, popup) {
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = content;
          if (tempDiv.querySelector('td img')) {
            popup._contentNode.classList.add('media');
            setTimeout(() => popup.update(), 10);
          } else {
            popup._contentNode.classList.remove('media');
          }
        }

        // Tile Layer
        map.createPane('pane_XYZLayer_0');
        map.getPane('pane_XYZLayer_0').style.zIndex = 400;
        const layer_XYZLayer_0 = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
          pane: 'pane_XYZLayer_0',
          opacity: 1.0,
          attribution: '',
          minZoom: 11,
          maxZoom: 11,
          minNativeZoom: 0,
          maxNativeZoom: 19,
        }).addTo(map);

        // Polygon style & popup
        function style_48_1_0() {
          return {
            pane: 'pane_48_1',
            opacity: 1,
            color: 'rgba(35,35,35,1.0)',
            dashArray: '',
            lineCap: 'butt',
            lineJoin: 'miter',
            weight: 1.0,
            fill: true,
            fillOpacity: 1,
            fillColor: 'rgba(40,86,156,1.0)',
            interactive: true,
          };
        }

        function pop_48_1(feature, layer) {
          const popupContent = `
            <table>
              <tr><td colspan="2">${feature.properties.OBJECTID ?? ''}</td></tr>
              <tr><th scope="row">TOWN</th><td>${feature.properties.TOWN ?? ''}</td></tr>
              <tr><td colspan="2">${feature.properties.SHAPE_Leng ?? ''}</td></tr>
              <tr><td colspan="2">${feature.properties.SHAPE_Area ?? ''}</td></tr>
              <tr><td colspan="2">${feature.properties['2022 Total'] ?? ''}</td></tr>
              <tr><td colspan="2">${feature.properties['2023 Total'] ?? ''}</td></tr>
              <tr><td colspan="2">${feature.properties['2024 Total'] ?? ''}</td></tr>
              <tr><th scope="row">Total GLCF Giving from 2022 to 2024</th><td class="visible-with-data" id="2022-2024 Total">${feature.properties['2022-2024 Total'] ?? ''}</td></tr>
              <tr><td colspan="2">${feature.properties.Org_Concat ?? ''}</td></tr>
              <tr><td colspan="2">${feature.properties.Processes ?? ''}</td></tr>
              <tr><th scope="row">Number of Grants</th><td class="visible-with-data" id="Num_Grants">${feature.properties.Num_Grants ?? ''}</td></tr>
              <tr><th scope="row">Number of Grantees</th><td class="visible-with-data" id="Num_Grantees">${feature.properties.Num_Grantees ?? ''}</td></tr>
              <tr><th scope="row">Number of Grant Processes</th><td class="visible-with-data" id="Num_Processes">${feature.properties.Num_Processes ?? ''}</td></tr>
            </table>
          `;
          const content = removeEmptyRowsFromPopupContent(popupContent, feature);
          layer.bindPopup(content, { maxHeight: 400 });
          layer.on('popupopen', (e) => addClassToPopupIfMedia(content, e.popup));

          layer.on({
            mouseover: function (e) {
              e.target.setStyle({ fillColor: '#ffff00', fillOpacity: 1 });
              e.target.openPopup();
            },
            mouseout: function (e) {
              layer.resetStyle(e.target);
              e.target.closePopup();
            },
          });
        }

        map.createPane('pane_48_1');
        map.getPane('pane_48_1').style.zIndex = 401;
        map.getPane('pane_48_1').style['mix-blend-mode'] = 'normal';

        // Add GeoJSON layer
        const layer_48_1 = L.geoJson(json_48_1, {
          style: style_48_1_0,
          onEachFeature: pop_48_1,
          pane: 'pane_48_1',
          interactive: true,
        }).addTo(map);

        // Fit bounds
        const bounds = layer_48_1.getBounds();
        map.fitBounds(bounds);
        map.setMaxBounds(bounds.pad(0.1));

        // Label Layer
        const townLabels = L.layerGroup().addTo(map);

        function measureLabelSize(text) {
          const tempDiv = document.createElement('div');
          tempDiv.style.position = 'absolute';
          tempDiv.style.visibility = 'hidden';
          tempDiv.style.fontFamily = "'Open Sans', sans-serif";
          tempDiv.style.fontWeight = '700';
          tempDiv.style.fontSize = '12px';
          tempDiv.style.whiteSpace = 'nowrap';
          tempDiv.style.padding = '2px 6px';
          tempDiv.innerText = text;
          document.body.appendChild(tempDiv);
          const width = tempDiv.offsetWidth;
          const height = tempDiv.offsetHeight;
          document.body.removeChild(tempDiv);
          return { width, height };
        }

        function getOffsetLatLng(baseLatLng, dxPixels, dyPixels) {
          const point = map.latLngToContainerPoint(baseLatLng);
          const offsetPoint = L.point(point.x + dxPixels, point.y + dyPixels);
          return map.containerPointToLatLng(offsetPoint);
        }

        function labelFitsInsidePolygon(feature, labelLatLng, labelWidth, labelHeight) {
          const topLeft = getOffsetLatLng(labelLatLng, -labelWidth / 2, -labelHeight);
          const topRight = getOffsetLatLng(labelLatLng, labelWidth / 2, -labelHeight);
          const bottomRight = getOffsetLatLng(labelLatLng, labelWidth / 2, 0);
          const bottomLeft = getOffsetLatLng(labelLatLng, -labelWidth / 2, 0);

          const labelPolygon = turf.polygon([
            [
              [topLeft.lng, topLeft.lat],
              [topRight.lng, topRight.lat],
              [bottomRight.lng, bottomRight.lat],
              [bottomLeft.lng, bottomLeft.lat],
              [topLeft.lng, topLeft.lat],
            ],
          ]);

          return turf.booleanContains(turf.feature(feature.geometry), labelPolygon);
        }

        function createFittedLabel(feature) {
          const townName = feature.properties.TOWN || 'Unknown';
          const labelPoint = turf.pointOnFeature(feature).geometry.coordinates;
          let labelLatLng = L.latLng(labelPoint[1], labelPoint[0]);

          const { width: labelWidth, height: labelHeight } = measureLabelSize(townName);

          let found = false;

          if (!labelFitsInsidePolygon(feature, labelLatLng, labelWidth, labelHeight)) {
            const maxShift = 40;
            outerLoop: for (let dx = -maxShift; dx <= maxShift; dx += 5) {
              for (let dy = -maxShift; dy <= maxShift; dy += 5) {
                const testLatLng = getOffsetLatLng(labelLatLng, dx, dy);
                if (labelFitsInsidePolygon(feature, testLatLng, labelWidth, labelHeight)) {
                  labelLatLng = testLatLng;
                  found = true;
                  break outerLoop;
                }
              }
            }
            if (!found) {
              console.warn(`Label for ${townName} doesn't fit inside polygon — using center`);
            }
          }

          return L.marker(labelLatLng, {
            icon: L.divIcon({
              className: 'town-label',
              html: `<div>${townName}</div>`,
            }),
            interactive: false,
            keyboard: false,
            riseOnHover: false,
          });
        }

        // Add labels
        layer_48_1.eachLayer(function (layer) {
          if (layer.feature) {
            const label = createFittedLabel(layer.feature);
            townLabels.addLayer(label);
          }
        });
      };
    </script>
  </body>
</html>
